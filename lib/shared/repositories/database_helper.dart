/*====================================================================
Tabellen-Name: Tabelle01    = Kontakte
----------------------------------------------------------------------
Spalten-Name: Tabelle01_001 = KontaktID - Primärschlüssel PRIMARY KEY
Spalten-Name: Tabelle01_002 = Anrede
Spalten-Name: Tabelle01_003 = Vorname
Spalten-Name: Tabelle01_004 = Nachname
Spalten-Name: Tabelle01_005 = Geburtstag
Spalten-Name: Tabelle01_006 = Straße
Spalten-Name: Tabelle01_007 = Zusatzinfo
Spalten-Name: Tabelle01_008 = PLZ
Spalten-Name: Tabelle01_009 = Ort
Spalten-Name: Tabelle01_010 = Land
Spalten-Name: Tabelle01_011 = Telefon1 - Mobil
Spalten-Name: Tabelle01_012 = Telefon2 - WhatsApp
Spalten-Name: Tabelle01_013 = E-Mail1
Spalten-Name: Tabelle01_014 = Webseite
Spalten-Name: Tabelle01_015 = Firmenname
Spalten-Name: Tabelle01_016 = Branche
Spalten-Name: Tabelle01_017 = Warengruppen
Spalten-Name: Tabelle01_018 = Kontakt-Notizen
Spalten-Name: Tabelle01_019 = Kontakt-Satus
Spalten-Name: Tabelle01_020 = Gruppe / Kategorie
Spalten-Name: Tabelle01_021 = Firmen-Straße
Spalten-Name: Tabelle01_022 = Firmen-PLZ
Spalten-Name: Tabelle01_023 = Firmen-Ort
Spalten-Name: Tabelle01_024 = Firmen-Land
Spalten-Name: Tabelle01_025 = Komplett-Adresse Privat (Phone)
Spalten-Name: Tabelle01_026 = Komplett-Adresse Geschäft (Phone)
Spalten-Name: Tabelle01_027 = 
Spalten-Name: Tabelle01_028 =
Spalten-Name: Tabelle01_029 =
Spalten-Name: Tabelle01_030 =
Spalten-Name: Tabelle01_031 =
Spalten-Name: Tabelle01_032 =
Spalten-Name: Tabelle01_033 =
Spalten-Name: Tabelle01_034 =
Spalten-Name: Tabelle01_035 =
Spalten-Name: Tabelle01_036 =
Spalten-Name: Tabelle01_037 =
Spalten-Name: Tabelle01_038 =
Spalten-Name: Tabelle01_039 =
Spalten-Name: Tabelle01_040 = 
Spalten-Name: Tabelle01_041 = 
Spalten-Name: Tabelle01_042 =
Spalten-Name: Tabelle01_043 = Kontakt-Quelle
Spalten-Name: Tabelle01_044 = Gebietskennung
Spalten-Name: Tabelle01_045 = Betreuungsstatus
Spalten-Name: Tabelle01_046 = Betreuer MA-NR
Spalten-Name: Tabelle01_047 = Stufe des Betreuers
Spalten-Name: Tabelle01_048 = Angelegt am xx um xx:xx Uhr
Spalten-Name: Tabelle01_049 = Angelegt von MA-NR
Spalten-Name: Tabelle01_050 = Zuletzt aktualisiert am xx um xx:xx Uhr
======================================================================
Tabellen-Name: Tabelle02    = Finanzen
----------------------------------------------------------------------
Spalten-Name: Tabelle02_001 = FinanzID - Primärschlüssel PRIMARY KEY
Spalten-Name: Tabelle02_002 = Belegnummer: AUS = Ausgabe, EIN = Einnahme
Spalten-Name: Tabelle02_003 = Beleg-Art: AUS = Ausgabe, EIN = Einnahme, REG = Rechnung, GUT = Gutschrift, GAR = Garantie 
Spalten-Name: Tabelle02_004 = Beleg-Datum
Spalten-Name: Tabelle02_005 = Wo gekauft
Spalten-Name: Tabelle02_006 = Was gekauft: Artikelbezeichnung
Spalten-Name: Tabelle02_007 = Menge: Anzahl
Spalten-Name: Tabelle02_008 = Einheit: Stück, m², l, kg, t, m³
Spalten-Name: Tabelle02_009 = Netto-EinzelPreis pro Einheit
Spalten-Name: Tabelle02_010 = Netto-Gesamtpreis
Spalten-Name: Tabelle02_011 = MwSt-Satz
Spalten-Name: Tabelle02_012 = Brutto-Einzelpreis pro Einheit
Spalten-Name: Tabelle02_013 = MwSt-Brutto-Gesamt
Spalten-Name: Tabelle02_014 = Brutto-Gesamtpreis
Spalten-Name: Tabelle02_015 = Währung
Spalten-Name: Tabelle02_016 = Zahlungsmittel: Bar, EC, Kreditkarte, PayPal, Überweisung
Spalten-Name: Tabelle02_017 = Zahlungsart: Einmalzahlung, Ratenzahlung
Spalten-Name: Tabelle02_018 = Finanz-Notizen
Spalten-Name: Tabelle02_019 = Einkäufer
Spalten-Name: Tabelle02_020 = Warengruppe
Spalten-Name: Tabelle02_021 = Artikelnummer
Spalten-Name: Tabelle02_022 = 
Spalten-Name: Tabelle02_023 = 
Spalten-Name: Tabelle02_024 = 
Spalten-Name: Tabelle02_025 = 
Spalten-Name: Tabelle02_026 = 
Spalten-Name: Tabelle02_027 =
Spalten-Name: Tabelle02_028 =
Spalten-Name: Tabelle02_029 =
Spalten-Name: Tabelle02_030 =
Spalten-Name: Tabelle02_031 =
Spalten-Name: Tabelle02_032 =
Spalten-Name: Tabelle02_033 =
Spalten-Name: Tabelle02_034 =
Spalten-Name: Tabelle02_035 =
Spalten-Name: Tabelle02_036 =
Spalten-Name: Tabelle02_037 =
Spalten-Name: Tabelle02_038 =
Spalten-Name: Tabelle02_039 =
Spalten-Name: Tabelle02_040 =
Spalten-Name: Tabelle02_041 =
Spalten-Name: Tabelle02_042 =
Spalten-Name: Tabelle02_043 =
Spalten-Name: Tabelle02_044 =
Spalten-Name: Tabelle02_045 =
Spalten-Name: Tabelle02_046 =
Spalten-Name: Tabelle02_047 =
Spalten-Name: Tabelle02_048 = Angelegt am xx um xx:xx Uhr
Spalten-Name: Tabelle02_049 = Angelegt von MA-NR
Spalten-Name: Tabelle02_050 = Zuletzt aktualisiert am xx um xx:xx Uhr
======================================================================
Tabellen-Name: Tabelle03    =
----------------------------------------------------------------------
Spalten-Name: Tabelle03_001 =
Spalten-Name: Tabelle03_002 =
======================================================================
Tabellen-Name: Tabelle04    =
----------------------------------------------------------------------
Spalten-Name: Tabelle04_001 =
Spalten-Name: Tabelle04_002 =
======================================================================
Tabellen-Name: Tabelle05    =
----------------------------------------------------------------------
Spalten-Name: Tabelle05_001 =
Spalten-Name: Tabelle05_002 =
======================================================================
Tabellen-Name: Tabelle06    =
----------------------------------------------------------------------
Spalten-Name: Tabelle06_001 =
Spalten-Name: Tabelle06_002 =
======================================================================
Tabellen-Name: Tabelle07    =
----------------------------------------------------------------------
Spalten-Name: Tabelle07_001 =
Spalten-Name: Tabelle07_002 =
======================================================================
Tabellen-Name: Tabelle08    =
----------------------------------------------------------------------
Spalten-Name: Tabelle08_001 =
Spalten-Name: Tabelle08_002 =
======================================================================
Tabellen-Name: Tabelle09    =
----------------------------------------------------------------------
Spalten-Name: Tabelle09_001 =
Spalten-Name: Tabelle09_002 =
======================================================================
Tabellen-Name: Tabelle10    = Einstellung-App-System
----------------------------------------------------------------------
Spalten-Name: Tabelle10_001 = EASID - Primärschlüssel PRIMARY KEY
Spalten-Name: Tabelle10_002 = App-Version
Spalten-Name: Tabelle10_003 = App-Name
Spalten-Name: Tabelle10_004 = App-Icon
Spalten-Name: Tabelle10_005 = JOTHAsoft-Logo
=====================================================================*/

import 'dart:developer' as dev;
import 'dart:math';

import 'package:flutter/material.dart';
import 'package:path/path.dart';
import 'package:sqflite/sqflite.dart';

/*--------------------------------- Singleton-Klasse DatabaseHelper ---*/
class DatabaseHelper {
  /*--- Singleton-Konstruktor ---*/
  static final DatabaseHelper instance = DatabaseHelper._privateConstructor();
  /*--- Datenbank-Objekt ---*/
  static Database? _database;
  /*--- Konstruktor ---*/
  DatabaseHelper._privateConstructor();

  /*--------------------------------- Die Datenbank erstellen ---*/
  Future<Database> get database async {
    dev.log('0093 - DatabaseHelper - Die Datenbank wird aktiviert.');
    /*--- Wenn die Datenbank bereits erstellt wurde, wird sie zurückgegeben ---*/
    if (_database != null) return _database!;
    dev.log('0095 - DatabaseHelper - Die Datenbank ist vorhanden.');
    /*--- Wenn die Datenbank noch nicht erstellt wurde, wird sie erstellt ---*/
    _database = await _initDB('JOTHAsoft.FiveStars.db');
    dev.log('0099 - DatabaseHelper - Die Datenbank muss erstellt erstellt werden.');
    /*--- Die Datenbank wird zurückgegeben ---*/
    return _database!;
  }

  /*--------------------------------- Die Datenbank wird in einem Ordner "WorkBuddy" gespeichert ---*/
  Future<Database> _initDB(String filePath) async {
    /*--- Pfad zum Ordner "WorkBuddy" ---*/
    final dbPath = join(await getDatabasesPath(), 'WorkBuddy');
    /*--- Pfad zur Datenbank ---*/
    final path = join(dbPath, filePath);
    dev.log(
      '0024 - DatabaseHelper - Datenbank wird in Ordner "WorkBuddy" gespeichert: $path',
    );
    /*--- Datenbank wird geöffnet ---*/
    return await openDatabase(path, version: 1, onCreate: _createDB);
  }

  /*--------------------------------- Controller erstellen ---*/
  final newNameController = TextEditingController();
  /*--- Dieser Code ersetzt eine Auflistung, die 50 Zeilen (nach diesem Muster) lang wäre: 
        final controllerTabelle01_002 = TextEditingController(); usw. ... ---*/
  final List<TextEditingController> controllerTabelle01_0 = List.generate(
    50,
    (_) => TextEditingController(),
  );

  /*--------------------------------- Die Datenbank erstellen ---*/
  /*--- Es werden 10 Tabellen mit je 50 Spalten erstellt. ---*/
  Future _createDB(Database db, int version) async {
    /* --- 10 Tabellen erstellen --- */
    for (int i = 1; i <= 10; i++) {
      String tableName = 'Tabelle${i.toString().padLeft(2, '0')}';
      dev.log('----------------------------------------------------------');
      dev.log('0044 - DatabaseHelper - Tabelle $tableName wird erstellt.');
      dev.log('----------------------------------------------------------');
      /* --- 50 Spalten erstellen --- */
      String columns = List.generate(50, (index) {
        String columnName =
            '${tableName}_${(index + 1).toString().padLeft(3, '0')}';
        dev.log('0049 - DatabaseHelper - Spalte $columnName wird erstellt.');
        /* --- Die erste Spalte (mit Index 0) ist der Primary Key --- */
        return index == 0 ? '$columnName TEXT PRIMARY KEY' : '$columnName TEXT';
      }).join(', ');
      /*--- CREATE TABLE mit dem Zusatz "IF NOT EXISTS" erstellt die Tabellen NUR wenn sie NICHT existieren ---*/
      await db.execute('''
        CREATE TABLE IF NOT EXISTS $tableName($columns)
      ''');
    }
  }

  /*--------------------------------- Überprüfen, ob die Datenbank bereits existiert ---*/
  Future<bool> databaseExists() async {
    /*--- Pfad zur Datenbank ---*/
    final dbPath = join(await getDatabasesPath(), 'WorkBuddy');
    /*--- Pfad zur Datenbank-Datei ---*/
    final path = join(dbPath, 'JOTHAsoft.FiveStars.db');
    dev.log(
      '0064 - DatabaseHelper - Überprüfen, ob die Datenbank existiert: $path',
    );
    /*--- Überprüfen, ob die Datenbank existiert ---*/
    return databaseFactory.databaseExists(path);
  }

  /*--------------------------------- Initialisieren der Datenbank ---*/
  Future<void> initializeDatabase() async {
    /*--- Überprüfen, ob die Datenbank bereits existiert ---*/
    bool dbExists = await databaseExists();
    /*--- Wenn die Datenbank noch nicht existiert, wird sie erstellt ---*/
    if (!dbExists) {
      /*--- Datenbank erstellen ---*/
      await database;
      dev.log(
        '0057 - DatabaseHelper - Datenbank wurde erstellt und initialisiert: ${await getDatabasesPath()}',
      );
      /*--- Wenn die Datenbank existiert ... ---*/
    } else {
      dev.log(
        '0059 - DatabaseHelper - Datenbank ist bereits vorhanden: ${await getDatabasesPath()}',
      );
    }
  }

  /*--------------------------------- Erstelle eine KontaktID aus 5 Teilen: 
      1) Random: 2 zufällige Großuchstaben
      2) + 1 Bindestrich
      3) + 2 zufällige Ziffern
      4) + 1 Bindestrich
      5) + Zeitstempel ---*/
  String generateContactID() {
    /*--- Für die zufällige Großbuchstaben-Liste ---*/
    const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    /*--- Random-Objekt erstellen ---*/
    final random = Random();
    /*--- Kontakt-ID erstellen ---*/
    final letterPart = String.fromCharCodes(
      Iterable.generate(
        2,
        (_) => letters.codeUnitAt(random.nextInt(letters.length)),
      ),
    );
    /*--- Zufällige Ziffern erstellen ---*/
    final numberPart = random.nextInt(100).toString().padLeft(2, '0');
    /*--- Zeitstempel erstellen ---*/
    final timestamp = DateTime.now().millisecondsSinceEpoch;
    dev.log(
      '0100 - DatabaseHelper - Kontakt-ID wurde erstellt: $letterPart-$numberPart-$timestamp',
    );
    /*--- Kontakt-ID zurückgeben ---*/
    return '$letterPart-$numberPart-$timestamp';
  }

  /*--------------------------------- Speichern von Daten in der Datenbank-Tabelle01 ---*/
  Future<void> saveData(Map<String, dynamic> dataToSave) async {
    /*--- Datenbank öffnen ---*/
    final db = await database;
    /*--- Kontakt-ID erstellen ---*/
    final contactID = generateContactID();
    /*--- Kontakt-ID in welche Spalte speichern? ---*/
    dataToSave['Tabelle01_001'] = contactID;
    dev.log(
      '0110 - DatabaseHelper - Kontakt-ID $contactID wird in "Tabelle01_001" gespeichert: $dataToSave',
    );
    /*--- INSERT = Speichern in der Datenbank ---*/
    await db.insert('Tabelle01', dataToSave);
  }

  /*--------------------------------- INSERT = Speichern von Name in der Datenbank ---*/
  Future<void> saveName(String name) async {
    /*--- Datenbank öffnen ---*/
    final db = await database;
    /*--- Kontakt-ID erstellen ---*/
    final contactID = generateContactID();
    /*--- Daten ---*/
    final Map<String, String> data = {'Tabelle01_001': contactID};

    /*--- Dieser Code ersetzt eine Auflistung, die 50 Zeilen bedeuten würde: 
    ----> 'Tabelle01_002': controllerTabelle01_002.text, usw. ... <----
          Es werden Daten in alle Tabellenfelder mit 'leer' gespeichert, 
          ansonsten wäre es 'null' (!) und das soll verhindert werden! ---*/
    for (int i = 0; i < controllerTabelle01_0.length; i++) {
      /*--- Daten in die Datenbank-Tabelle speichern ---*/
      data['Tabelle01_${(i + 2).toString().padLeft(3, '0')}'] =
          controllerTabelle01_0[i].text;
      dev.log(
        '0127 - DatabaseHelper - Auflistung: $data - Controller: ${controllerTabelle01_0[i].text}',
      );
    }

    /*--------------------------------- INSERT = Speichern in der Datenbank ---*/
    await db.insert(
      /*--- Tabellen-Name ---*/
      'Tabelle01',
      /*--- Daten ---*/
      data,
      /*--- Konflikt-Algorithmus ---*/
      conflictAlgorithm: ConflictAlgorithm.replace,
    );
  }

  /*--------------------------------- UPDATE = Bearbeiten von Name in der Datenbank ---*/
  Future<void> updateName(String name) async {
    /*--- Datenbank öffnen ---*/
    final db = await database;
    /*--- UPDATE = Bearbeiten ---*/
    await db.update(
      /*--- Tabellen-Name ---*/
      'Tabelle01',
      /*--- Spalten-Name und Wert ---*/
      {'Tabelle01_002': name},
      /*--- Bedingung ---*/
      where: 'Tabelle01_002 = ?',
      /*--- Argument ---*/
      whereArgs: [name],
    );
  }

  /*--------------------------------- DELETE = Löschen von Name in der Datenbank ---*/
  Future<void> deleteName(String name) async {
    /*--- Datenbank öffnen ---*/
    final db = await database;
    /*--- DELETE = Löschen ---*/
    await db.delete(
      /*--- Tabellen-Name ---*/
      'Tabelle01',
      /*--- Bedingung ---*/
      where: 'Tabelle01_002 = ?',
      /*--- Argument ---*/
      whereArgs: [name],
    );
  }

  /*--------------------------------- SELECT = Abrufen von Name in der Datenbank ---*/
  Future<String?> getName() async {
    /*--- Datenbank öffnen ---*/
    final db = await database;
    /*--- SELECT = Abrufen ---*/
    final result = await db.query(
      /*--- Tabellen-Name ---*/
      'Tabelle01',
      /*--- Spalten-Name ---*/
      columns: ['Tabelle01_002'],
      /*--- Limitierung auf 1 Datensatz ---*/
      limit: 1,
    );
    /*--- Wenn der Datensatz nicht leer ist, wird der Name abgerufen ---*/
    if (result.isNotEmpty) {
      dev.log('0163 - DatabaseHelper - Name wurde abgerufen.');
      return result.first['Tabelle01_002'] as String?;
    }
    return null;
  }

  /*--------------------------------- Alle Namen auflisten = SELECT ---*/
  Future<List<Map<String, dynamic>>> getAllRecords() async {
    /*--- Datenbank öffnen ---*/
    dev.log('0170 - DatabaseHelper - Alle Datensätze werden abgerufen.');
    final db = await database;
    /*--- Alle Datensätze abrufen ---*/
    return await db.query('Tabelle01');
  }

  /*--------------------------------- Funktion zum Löschen der gesamten Datenbank ---*/
  Future<void> deleteDatabase() async {
    /*--- Datenbank öffnen ---*/
    final dbPath = join(await getDatabasesPath(), 'WorkBuddy');
    /*--- Pfad zur Datenbank ---*/
    final path = join(dbPath, 'JOTHAsoft.FiveStars.db');
    /*--- Löschen der Datenbank ---*/
    await databaseFactory.deleteDatabase(path);
    /*--- Datenbank-Objekt auf null setzen ---*/
    _database = null;
    dev.log('0180 - DatabaseHelper - Datenbank wurde gelöscht: $path');
  }

  // String getControllerText(int index) {
  //   if (index < 0 || index >= controllerTabelle01_0.length) {
  //     throw RangeError('Index out of range');
  //   }
  //   return controllerTabelle01_0[index].text;
  // }
}
